<!DOCTYPE html>  <html> <head>   <title>milk.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               milk.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Milk is a simple, fast way to get more Mustache into your CoffeeScript and
Javascript.</p>

<p>Plenty of good resources for Mustache can be found
<a href="mustache.github.com">here</a>, so little will be said about the templating
language itself here.</p>

<p>Template rendering is broken into a couple of distinct phases: deconstructing
a parse tree, and generating the final result.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Parsing</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>In the simplest case, we'll simply need a template string to parse.  If we've
parsed this template before, the cache will let us bail early.  We do need to
remember to take the tag delimiters into account, however -- different parse
trees can exist for the same raw template!</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Mustache templates are reasonably simple -- plain text templates are
sprinkled with "tags", which are (by default) a pair of curly braces
surrounding some bit of content.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">TemplateCache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nx">Parse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{{&#39;</span><span class="p">,</span><span class="s1">&#39;}}&#39;</span><span class="p">],</span> <span class="nx">sectionName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">cache</span> <span class="o">=</span> <span class="p">(</span><span class="nx">TemplateCache</span><span class="p">[</span><span class="nx">delimiters</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span> <span class="o">||=</span> <span class="p">{})</span>
  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">template</span><span class="p">]</span> <span class="k">if</span> <span class="nx">template</span> <span class="k">of</span> <span class="nx">cache</span>

  <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We're going to take the easy route this time, and just match away large
parts of the template with a regular expression.  This isn't likely the
fastest approach, but it is fairly simple.
Since the tag delimiters may change over time, we'll need to be able to
rebuild the regex when they change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[</span><span class="nx">tagOpen</span><span class="p">,</span> <span class="nx">tagClose</span><span class="p">]</span> <span class="o">=</span> <span class="nx">delimiters</span>
  <span class="nx">BuildRegex</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="err">///</span>
      <span class="p">([</span><span class="err">\</span><span class="nx">s</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">*?</span><span class="p">)</span>                <span class="c1"># Capture the pre-tag content</span>
      <span class="p">([</span><span class="c1">#{&#39; &#39;}\t]*)             # Capture the pre-tag whitespace</span>
      <span class="p">(</span><span class="o">?:</span> <span class="c1">#{tagOpen} \s*        # Match the opening tag</span>
      <span class="p">(</span><span class="o">?:</span>
        <span class="p">(</span><span class="o">=</span><span class="p">)</span>            <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">(.</span><span class="o">+?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="o">=</span> <span class="o">|</span> <span class="c1"># Set Delimiters</span>
        <span class="p">({)</span>            <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">(.</span><span class="o">+?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">}</span> <span class="o">|</span> <span class="c1"># Triple Mustaches</span>
        <span class="p">([</span><span class="o">^</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z</span><span class="p">.</span><span class="nx">_</span><span class="p">]</span><span class="o">?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">([</span><span class="err">\</span><span class="nx">s</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">+?</span><span class="p">)</span>    <span class="c1"># Everything else</span>
      <span class="p">)</span>
      <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="c1">#{tagClose} )         # Match the closing tag</span>
    <span class="err">///gm</span>

  <span class="nx">tagPattern</span> <span class="o">=</span> <span class="nx">BuildRegex</span><span class="p">()</span>
  <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">start</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>In case we run into problems, we need to be able to provide good diagnostic
messages for the user.  We'll build a message with the line number, the
template line in question, and the approximate position of the error within
that line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">parseError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">errorPos</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">endOfLine</span> <span class="o">=</span> <span class="sr">/$/gm</span><span class="p">).</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">errorPos</span>
    <span class="nx">endOfLine</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>

    <span class="nx">parsedLines</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">errorPos</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
    <span class="nx">lastLine</span>    <span class="o">=</span> <span class="nx">parsedLines</span><span class="p">[</span><span class="nx">parsedLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nx">lastTag</span>     <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">contentEnd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">errorPos</span> <span class="o">-</span> <span class="nx">contentEnd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nx">indent</span>  <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">lastTag</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nx">carets</span>  <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">lastTag</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span>
    <span class="nx">message</span> <span class="o">=</span> <span class="p">[</span>
      <span class="nx">message</span><span class="p">,</span>
      <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s2">&quot;Line #{parsedLines.length}:&quot;</span><span class="p">,</span> 
      <span class="nx">lastLine</span> <span class="o">+</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">errorPos</span><span class="p">,</span> <span class="nx">endOfLine</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">-</span> <span class="nx">errorPos</span><span class="p">),</span>
      <span class="s2">&quot;#{indent}#{carets}&quot;</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>As we start matching things, we'll pull out the relevant captures, indices,
and deterimine whether the tag is standalone.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">while</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">content</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="nx">tag</span>  <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

    <span class="nx">contentEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nx">pos</span>        <span class="o">=</span> <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span>

    <span class="nx">isStandalone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">contentEnd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">or</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">contentEnd</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span> <span class="kc">undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Append the static content to the buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span> <span class="nx">content</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If we're dealing with a standalone non-interpolation tag, we should skip
over the newline immediately following the tag.  If we're not, we need
give back the whitespace we've been holding hostage.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">isStandalone</span> <span class="o">and</span> <span class="nx">type</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">]</span>
      <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\r&#39;</span>
      <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">whitespace</span>
      <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">whitespace</span><span class="p">)</span>
      <span class="nx">contentEnd</span> <span class="o">+=</span> <span class="nx">whitespace</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">whitespace</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Next, we'll handle the tag itself:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Comment tags should simply be ignored.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;!&#39;</span> <span class="k">then</span> <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Interpolation tags only require the tag name.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span> <span class="k">then</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">tag</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Partial will require the tag name and any leading whitespace, which
will be used to indent the partial.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;&gt;&#39;</span> <span class="k">then</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">whitespace</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Sections and Inverted Sections make a recursive call to <code>Parse</code>,
starting immediately after the tag.  This call will continue to walk
through the template until it reaches an End Section tag, when it will
return the subtemplate it's parsed (and cached!) and the index after
the End Section tag.  We'll save the tag name, current delimiters, and
the subtemplate string.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span>
        <span class="p">[</span><span class="nx">tmpl</span><span class="p">,</span> <span class="nx">pos</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="p">[</span><span class="nx">tagOpen</span><span class="p">,</span> <span class="nx">tagClose</span><span class="p">],</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="p">[[</span><span class="nx">tagOpen</span><span class="p">,</span> <span class="nx">tagClose</span><span class="p">],</span> <span class="nx">tmpl</span><span class="p">]</span> <span class="p">]</span>

      <span class="k">when</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="nx">tag</span> <span class="o">!=</span> <span class="nx">sectionName</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;End Section tag closes &#39;#{tag}&#39;; expected &#39;#{sectionName}&#39;!&quot;</span>
        <span class="nx">unless</span> <span class="nx">sectionName</span><span class="o">?</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;End Section tag &#39;#{tag}&#39; found, but not in section!&quot;</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="k">if</span> <span class="nx">error</span>

        <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">[</span><span class="nx">start</span><span class="p">..</span><span class="nx">contentEnd</span><span class="p">]</span>
        <span class="nx">TemplateCache</span><span class="p">[</span><span class="nx">delimiters</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)][</span><span class="nx">template</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">template</span><span class="p">,</span> <span class="nx">pos</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The Set Delimiters tag doesn't actually generate output, but instead
changes the tagPattern that the parser uses.  All delimiters need to be
regex escaped for safety.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;=&#39;</span>
        <span class="nx">delims</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>

        <span class="nx">unless</span> <span class="nx">delims</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;Set Delimiters tags should have two and only two values!&quot;</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="k">if</span> <span class="nx">error</span>

        <span class="p">[</span><span class="nx">tagOpen</span><span class="p">,</span> <span class="nx">tagClose</span><span class="p">]</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">delim</span> <span class="k">in</span> <span class="nx">delims</span>
          <span class="nx">delim</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[-[\]{}()*+?.,\\^$|#]/g</span><span class="p">,</span> <span class="s2">&quot;\\$&amp;&quot;</span><span class="p">)</span>
        <span class="nx">tagPattern</span> <span class="o">=</span> <span class="nx">BuildRegex</span><span class="p">()</span>

      <span class="k">else</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="s2">&quot;Unknown tag type -- #{type}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>And finally, we'll advance the tagPattern's lastIndex (so that it resumes
parsing where we intend it to), and loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">pos</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>When we've exhausted all of the matches for tagPattern, we'll still have a
small portion of the template remaining.  We'll append it to the buffer,
cache it, and return the buffer!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">template</span><span class="p">[</span><span class="nx">pos</span><span class="p">..])</span>
  <span class="k">return</span> <span class="nx">TemplateCache</span><span class="p">[</span><span class="nx">delimiters</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)][</span><span class="nx">template</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Generating</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Once we have a parse tree, transforming it back into a full template should
be fairly straightforward.  We start by building a context stack, which data
will be looked up from.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Generate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">partials</span><span class="p">,</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">Escape</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>

  <span class="nx">Build</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tmpl</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">Generate</span><span class="p">(</span><span class="nx">Parse</span><span class="p">(</span><span class="s2">&quot;#{tmpl}&quot;</span><span class="p">,</span> <span class="nx">delims</span><span class="p">),</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">partials</span><span class="p">,</span> <span class="p">[</span><span class="nx">context</span><span class="p">...],</span> <span class="nx">Escape</span><span class="p">)</span>

  <span class="nx">parts</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">buffer</span>
    <span class="k">switch</span> <span class="k">typeof</span> <span class="nx">part</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Strings in the buffer can be used literally.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;string&#39;</span> <span class="k">then</span> <span class="nx">part</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Parsed tags (which will be Arrays in the given buffer) will need to be
evaluated against the context stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span>
        <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">]</span> <span class="o">=</span> <span class="nx">part</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;&gt;&#39;</span>

        <span class="k">switch</span> <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Partials will be looked up by name (in this case, from the given
hash) and built.  (Parsing the partial here means that we don't
have to worry about recursive partials.)  If the partial tag was
standalone and indented, the resulting content should be similarly
indented.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">when</span> <span class="s1">&#39;&gt;&#39;</span>
            <span class="nx">partial</span> <span class="o">=</span> <span class="nx">partials</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nx">partial</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(?=.)/gm</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="k">if</span> <span class="nx">data</span>
            <span class="nx">Build</span><span class="p">(</span><span class="nx">partial</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Sections will render when the name specified retreives a truthy
value from the context stack, and should be repeated for each
element if the value is an array.  If the value is a function, it
should be called with the raw section template, and the return
value should be built.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">when</span> <span class="s1">&#39;#&#39;</span>
            <span class="p">[</span><span class="nx">delims</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">value</span> <span class="o">||=</span> <span class="p">[]).</span><span class="nx">constructor</span>
              <span class="k">when</span> <span class="nb">Array</span>
                <span class="p">(</span><span class="nx">Build</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">value</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
              <span class="k">when</span> <span class="nb">Function</span>
                <span class="nx">Build</span><span class="p">(</span><span class="nx">value</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span>
              <span class="k">else</span>
                <span class="nx">Build</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Inverted Sections render under almost opposite conditions: their
contents will only be rendered whene the retrieved value is falsey,
or is an empty array.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">when</span> <span class="s1">&#39;^&#39;</span>
            <span class="p">[</span><span class="nx">delims</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span>
            <span class="nx">empty</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">||=</span> <span class="p">[])</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nx">empty</span> <span class="k">then</span> <span class="nx">Build</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Unescaped interpolations should be returned directly; Escaped
interpolations will need to be HTML escaped for safety.
For lambdas that we receive, we'll simply call them and compile
whatever they return.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">when</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span> 
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">Build</span><span class="p">(</span><span class="nx">value</span><span class="p">().</span><span class="nx">toString</span><span class="p">())</span> <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Function</span>
            <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
          <span class="k">when</span> <span class="s1">&#39;&#39;</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">Build</span><span class="p">(</span><span class="nx">value</span><span class="p">().</span><span class="nx">toString</span><span class="p">())</span> <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Function</span>
            <span class="nx">Escape</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>

          <span class="k">else</span>
            <span class="k">throw</span> <span class="s2">&quot;Unknown tag type -- #{type}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The generated result is the concatenation of all these parts.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>Helpers</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><code>Find</code> will walk the context stack from top to bottom, looking for an element
with the given name.  '.' is a special name, representing the element on the
top of the stack, and dotted names perform chained resolutions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Find</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">stack</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span>
  <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parts</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\./</span><span class="p">)</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">?</span>
    <span class="k">continue</span> <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">name</span> <span class="k">of</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">break</span>

  <span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">part</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">])</span> <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">parts</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>If the value is a function, it will be treated like an object method;
we'll call it, and use its return value as the new value.  Object methods
being used for sections receive the raw section content, and automatically
render the returned values against the current context.
If the result is also a function, we'll treat that as an unbound lambda.
Lambdas are treated as object methods, except that <code>this</code> is not bound.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Function</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">do</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="p">(</span><span class="nx">tmpl</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[</span><span class="nx">tmpl</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="o">and</span> <span class="nx">val</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">)</span> <span class="o">or</span> <span class="nx">val</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Null values will be coerced to the empty string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">value</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>Exports</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>In CommonJS-based environments, Milk will export both a <code>render</code> function
and a function <code>escape</code> for doing basic HTML escaping.
In browsers, and other non-CommonJS environments, the object <code>Milk</code> will be
exported to the global namespace, containing the same methods.</p>

<p>The <code>Milk</code> export also contains a special key, <code>Milk.helpers</code>.  Any object
(or every object of an array) assigned to this key will be accessible on the
bottom of the context stack, allowing for common behavior (e.g. markup,
highlighting, or internationalization) to be made "globally" available to
the rendering engine.</p>

<p>All environments presently support only synchronous rendering of in-memory
templates, partials, and data.</p>

<p>Happy hacking!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Render</span> <span class="o">=</span> <span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">partials</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">helpers</span> <span class="o">=</span> <span class="k">if</span> <span class="err">@</span><span class="nx">helpers</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="k">then</span> <span class="p">[</span><span class="err">@</span><span class="nx">helpers</span><span class="p">...]</span> <span class="k">else</span> <span class="p">[</span><span class="err">@</span><span class="nx">helpers</span><span class="p">]</span>

  <span class="nx">partials</span> <span class="o">||=</span> <span class="err">@</span><span class="nx">partials</span> <span class="o">||</span> <span class="p">{}</span>
  <span class="nx">unless</span> <span class="nx">partials</span> <span class="k">instanceof</span> <span class="nb">Function</span>
    <span class="nx">partials</span> <span class="o">=</span> <span class="nx">do</span> <span class="p">(</span><span class="nx">partials</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="k">throw</span> <span class="s2">&quot;Unknown partial &#39;#{name}&#39;!&quot;</span> <span class="nx">unless</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">partials</span>
      <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">[</span><span class="nx">partials</span><span class="p">])</span>

  <span class="k">return</span> <span class="nx">Generate</span><span class="p">(</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">template</span><span class="p">),</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">partials</span><span class="p">,</span> <span class="nx">helpers</span><span class="p">,</span> <span class="err">@</span><span class="nx">escape</span><span class="p">)</span>

<span class="nx">Milk</span> <span class="o">=</span>
  <span class="nv">render: </span><span class="o">-&gt;</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">exports</span> <span class="o">?</span> <span class="nx">Milk</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
  <span class="nv">helpers: </span><span class="p">[]</span>
  <span class="nv">escape: </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">entities</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">:</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">:</span> <span class="s1">&#39;quot&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;gt&#39;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&amp;&quot;&lt;&gt;]/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">char</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;&amp;#{ entities[char] };&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nx">exports</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Milk</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">Milk</span>
<span class="k">else</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">Milk</span> <span class="o">=</span> <span class="nx">Milk</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 